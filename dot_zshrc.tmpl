# Enable Powerlevel10k instant prompt (must be at top)
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Path to your oh-my-zsh installation.
export ZSH="$HOME/.oh-my-zsh"

{{- if eq .chezmoi.os "linux" }}
# Path to nvim (Linux)
export PATH="$PATH:/opt/nvim-linux-x86_64/bin"
{{- end }}

# Rust toolchain (for cargo-installed tools like `delta`)
case ":$PATH:" in
  *":$HOME/.cargo/bin:"*) ;;
  *) export PATH="$HOME/.cargo/bin:$PATH" ;;
esac

{{- if eq .chezmoi.os "darwin" }}
# Homebrew (macOS)
eval "$(/opt/homebrew/bin/brew shellenv)"
{{- end }}

# Use Powerlevel10k theme
ZSH_THEME="powerlevel10k/powerlevel10k"

# Plugins - syntax-highlighting must be last
plugins=(
    git
    zsh-autosuggestions
    zsh-completions
    zsh-syntax-highlighting
)

# Initialize completions
fpath+=${ZSH_CUSTOM:-${ZSH:-~/.oh-my-zsh}/custom}/plugins/zsh-completions/src

source $ZSH/oh-my-zsh.sh

# User configuration

# History settings
HISTSIZE=50000
SAVEHIST=50000
setopt HIST_IGNORE_ALL_DUPS  # Don't record duplicates
setopt HIST_FIND_NO_DUPS     # Don't show duplicates when searching
setopt SHARE_HISTORY         # Share history between sessions

# Better directory navigation
setopt AUTO_CD               # Type directory name to cd into it
setopt AUTO_PUSHD            # Make cd push old directory onto stack
setopt PUSHD_IGNORE_DUPS     # Don't push duplicates
setopt CDABLE_VARS           # cd into variable values

# Completion settings
zstyle ':completion:*' menu select
zstyle ':completion:*' matcher-list 'm:{a-zA-Z}={A-Za-z}'  # Case insensitive

# Useful aliases
if command -v eza >/dev/null 2>&1; then
  alias ls='eza --icons --group-directories-first'
  alias ll='eza -lah --icons --group-directories-first'
  alias la='eza -a --icons --group-directories-first'
  alias l='eza --icons --group-directories-first'
  alias lt='eza --tree --level=2 --icons --group-directories-first'
  alias lta='eza --tree --level=3 --icons --group-directories-first -a'
else
  alias ll='ls -alh --color=auto'
  alias la='ls -A --color=auto'
  alias l='ls -CF --color=auto'
fi

alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias grep='grep --color=auto'
alias rg='rg --smart-case'           # Keep rg as rg, smarter default
{{- if eq .chezmoi.os "linux" }}
alias cat='batcat --paging=never'
alias bat='batcat'
alias fd='fdfind'
alias update='sudo apt update && sudo apt upgrade -y'
alias localip='hostname -I | cut -d" " -f1'
{{- else if eq .chezmoi.os "darwin" }}
alias cat='bat --paging=never'
alias update='brew update && brew upgrade'
alias localip='ipconfig getifaddr en0'
{{- end }}
alias please='sudo $(fc -ln -1)'     # Re-run last command with sudo
alias reload='exec zsh'              # Restart shell
alias path='echo $PATH | tr ":" "\n"'  # Show PATH entries one per line
alias myip='curl -s ifconfig.me'     # Public IP

# Git aliases
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git pull'
alias gd='git diff'
alias gco='git checkout'
alias gcb='git checkout -b'
alias gcm='git commit -m'
alias gb='git branch'
alias glog='git log --oneline --graph --decorate'

{{- if eq .chezmoi.os "linux" }}
# ASUS ROG shortcuts (Linux-only)
alias gpu-status='supergfxctl --get'
alias gpu-hybrid='supergfxctl --mode Hybrid && echo "Logout required"'
alias gpu-integrated='supergfxctl --mode Integrated && echo "Logout required"'
alias profile='asusctl profile -p'
alias rog='rog-control-center'
{{- end }}

# Development
alias py='python3'
alias pip='pip3'
alias dc='docker compose'
alias k='kubectl'

# GitHub CLI
alias ghpr='gh pr create'
alias ghpv='gh pr view --web'

# tmux shortcuts
alias tn='tmux new -s'
alias ta='tmux attach -t'
alias tl='tmux list-sessions'

# uv (Python)
alias uvr='uv run'
alias uvs='uv sync'
alias uva='uv add'
alias uvp='uv pip'

# ═══════════════════════════════════════════════════════════════
# Useful Functions
# ═══════════════════════════════════════════════════════════════

# Make directory and cd into it
mkcd() {
  mkdir -p "$1" && cd "$1"
}

# Extract any archive
extract() {
  if [ -f "$1" ]; then
    case "$1" in
      *.tar.bz2)   tar xjf "$1"    ;;
      *.tar.gz)    tar xzf "$1"    ;;
      *.tar.xz)    tar xJf "$1"    ;;
      *.bz2)       bunzip2 "$1"    ;;
      *.rar)       unrar x "$1"    ;;
      *.gz)        gunzip "$1"     ;;
      *.tar)       tar xf "$1"     ;;
      *.tbz2)      tar xjf "$1"    ;;
      *.tgz)       tar xzf "$1"    ;;
      *.zip)       unzip "$1"      ;;
      *.Z)         uncompress "$1" ;;
      *.7z)        7z x "$1"       ;;
      *)           echo "'$1' cannot be extracted via extract()" ;;
    esac
  else
    echo "'$1' is not a valid file"
  fi
}

# Quick git commit with message
gac() {
  git add -A && git commit -m "$*"
}

# Git add, commit, push in one command
gacp() {
  git add -A && git commit -m "$*" && git push
}

# Clone and cd into repo
gclone() {
  git clone "$1" && cd "$(basename "$1" .git)"
}

# Search process by name
psg() {
  ps aux | rg -i "$1"
}

# Quickly serve current directory
serve() {
  local port="${1:-8000}"
  python3 -m http.server "$port"
}

# Weather in terminal
weather() {
  curl -s "wttr.in/${1:-}"
}

# Cheat.sh - community cheat sheets
cheat() {
  curl -s "cheat.sh/$1"
}

# System tools (modern replacements)
alias top='btop'                          # Better TUI system monitor
alias help='tldr'                         # Simplified man pages
# Prefer ncdu for interactive disk analysis (TUI)
# du is kept as-is for scripting; use ncdu interactively
{{- if eq .chezmoi.os "linux" }}
alias rm='trash-put'                      # Safe delete (moves to trash)
alias rmi='/bin/rm -i'                    # Real rm with confirmation
{{- else if eq .chezmoi.os "darwin" }}
alias rm='trash'                          # Safe delete (brew install trash)
alias rmi='/bin/rm -i'                    # Real rm with confirmation
{{- end }}

# fzf integration for powerful fuzzy finding
{{- if eq .chezmoi.os "linux" }}
alias fzp='fzf --preview "batcat --color=always --style=numbers --line-range=:500 {}"'
fcd() {
  local depth="${1:-6}"
  local dir

  dir="$(
    fdfind . -t d --max-depth "$depth" --exclude .git --exclude node_modules 2>/dev/null |
      fzf --preview 'if command -v eza >/dev/null 2>&1; then eza --tree --level=2 --icons --group-directories-first --color=always "{}"; else ls -la "{}"; fi' \
          --preview-window=right:50%:wrap
  )" || return

  [ -n "$dir" ] || return
  cd "$dir" || return
}

fopen() {
  local file
  file="$(
    fdfind . -t f --exclude .git --exclude node_modules 2>/dev/null |
      fzf --preview 'batcat --color=always --style=numbers --line-range=:200 "{}" 2>/dev/null || sed -n "1,200p" "{}"' \
          --preview-window=right:60%:wrap
  )" || return

  [ -n "$file" ] || return
  xdg-open "$file" >/dev/null 2>&1 &
}
{{- else if eq .chezmoi.os "darwin" }}
alias fzp='fzf --preview "bat --color=always --style=numbers --line-range=:500 {}"'
fcd() {
  local depth="${1:-6}"
  local dir

  dir="$(
    fd . -t d --max-depth "$depth" --exclude .git --exclude node_modules 2>/dev/null |
      fzf --preview 'if command -v eza >/dev/null 2>&1; then eza --tree --level=2 --icons --group-directories-first --color=always "{}"; else ls -la "{}"; fi' \
          --preview-window=right:50%:wrap
  )" || return

  [ -n "$dir" ] || return
  cd "$dir" || return
}

fopen() {
  local file
  file="$(
    fd . -t f --exclude .git --exclude node_modules 2>/dev/null |
      fzf --preview 'bat --color=always --style=numbers --line-range=:200 "{}" 2>/dev/null || sed -n "1,200p" "{}"' \
          --preview-window=right:60%:wrap
  )" || return

  [ -n "$file" ] || return
  open "$file"
}
{{- end }}
alias fh='history | fzf --tac'            # Fuzzy history search

# Quick system tools
alias disk='ncdu /'                       # Analyze full disk
alias ports='ss -tulpn'                   # Show open ports
alias mem='free -h'                       # Memory usage
alias cpu='btop --utf-force'              # CPU monitor

# Color output
export LESS='-R'
if diff --help 2>/dev/null | command grep -q -- '--color'; then
  alias diff='diff --color=auto'
fi
if ip -h 2>/dev/null | command grep -Eq -- ' -c\b|--color'; then
  alias ip='ip -c'
fi
if command -v tree >/dev/null 2>&1; then
  alias tree='tree -C'
fi

# Better git diffs (delta)
if command -v delta >/dev/null 2>&1; then
  export GIT_PAGER='delta'
fi

alias ff='fastfetch'

# Load Powerlevel10k config if it exists
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh

# fzf keybindings (Ctrl+R for history, Ctrl+T for files, Alt+C for cd)
{{- if eq .chezmoi.os "linux" }}
[ -f /usr/share/doc/fzf/examples/key-bindings.zsh ] && source /usr/share/doc/fzf/examples/key-bindings.zsh
[ -f /usr/share/doc/fzf/examples/completion.zsh ] && source /usr/share/doc/fzf/examples/completion.zsh
{{- else if eq .chezmoi.os "darwin" }}
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh
{{- end }}

# Disable bracketed paste mode for VSCode terminal
unset zle_bracketed_paste

# fnm
FNM_PATH="$HOME/.local/share/fnm"
if [ -d "$FNM_PATH" ]; then
  export PATH="$FNM_PATH:$PATH"
  eval "`fnm env`"
fi

# zoxide (smarter cd)
if command -v zoxide >/dev/null 2>&1; then
  eval "$(zoxide init zsh)"
fi

# direnv (per-project env vars)
if command -v direnv >/dev/null 2>&1; then
  eval "$(direnv hook zsh)"
fi

# ═══════════════════════════════════════════════════════════════
# Shortcut & Alias Reference
# ═══════════════════════════════════════════════════════════════

# Ensure local scripts are available (includes `shortcut-ref`).
case ":$PATH:" in
  *":$HOME/.local/bin:"*) ;;
  *) export PATH="$HOME/.local/bin:$PATH" ;;
esac

# Prefer the installed script over a shell function.
alias shortcuts="$HOME/.local/bin/shortcut-ref"

# opencode
export PATH=$HOME/.opencode/bin:$PATH
. "/home/ashes/.deno/env"
